-- Reset Booklyverse test ledger data for clean stress tests
-- Ledger ID: 0a885204-e07a-48c1-97e9-495ac96a2581 (Booklyverse - actual test ledger)

DO $$
DECLARE
  v_ledger_id UUID := '0a885204-e07a-48c1-97e9-495ac96a2581';
BEGIN
  RAISE NOTICE 'Resetting Booklyverse test ledger: %', v_ledger_id;
  
  -- Delete entries first (foreign key to transactions)
  DELETE FROM entries WHERE transaction_id IN (
    SELECT id FROM transactions WHERE ledger_id = v_ledger_id
  );
  RAISE NOTICE 'Deleted entries';
  
  -- Delete invoice payments (foreign key to invoices)
  DELETE FROM invoice_payments WHERE invoice_id IN (
    SELECT id FROM invoices WHERE ledger_id = v_ledger_id
  );
  RAISE NOTICE 'Deleted invoice payments';
  
  -- Delete invoices
  DELETE FROM invoices WHERE ledger_id = v_ledger_id;
  RAISE NOTICE 'Deleted invoices';
  
  -- Delete transactions
  DELETE FROM transactions WHERE ledger_id = v_ledger_id;
  RAISE NOTICE 'Deleted transactions';
  
  -- Delete tax buckets BEFORE accounts (foreign key to accounts)
  DELETE FROM tax_buckets WHERE ledger_id = v_ledger_id;
  RAISE NOTICE 'Deleted tax buckets';
  
  -- Delete payouts BEFORE accounts (foreign key to accounts)
  DELETE FROM payouts WHERE ledger_id = v_ledger_id;
  RAISE NOTICE 'Deleted payouts';
  
  -- Delete accounts LAST
  DELETE FROM accounts WHERE ledger_id = v_ledger_id;
  RAISE NOTICE 'Deleted accounts';
  
  RAISE NOTICE 'Booklyverse test ledger reset complete';
END;
$$;
